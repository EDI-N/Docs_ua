####################################################
Модуль підписання Doc-Sign-Service
####################################################

.. contents:: Зміст:
   :depth: 3

---------

В даній інструкції описані можливості використання Модуля підписання Doc-Sign-Service (надалі просто Модуль підписання), порядок дій для встановлення його, як додатку та реалізоване API (http-запити).

Модуль дозволяє миттєво підписувати велику кількість документів, що створюються в різних облікових системах клієнта.

1 Загальні схеми інтеграції
===============================================

Робота з модулем передбачається згідно подальшої схеми: **API DocSign <- Облікова система клієнта -> API EDIN 2.0**

.. image:: files/Modul_pidpysannia_Doc_Sign_Service_13.png
   :align: center

.. image:: files/Modul_pidpysannia_Doc_Sign_Service_12.png
   :align: center

.. deprecated Наприклад, для сервісу ЕТТН схема виглядає наступним чином:

   .. image:: files/Modul_pidpysannia_Doc_Sign_Service_10.png
      :align: center

2 Технічні вимоги
===============================================

1. OC: операційні системи сімейства Linux;
2. Встановлена Jаva версії 13 і вище;
3. відкритий доступ до адрес АЦСК, https://iit.com.ua/, а також https://doc-sign.edin.ua/

3 Опис програми
===============================================

Додаток являє собою REST сервер написаний на Java, та розгортається в локальному середовищі.

4 Запуск та налаштування програми
===============================================

Наданий архів необхідно розпакувати в окрему директорію (папку). В данній вибраній директорії відкрити термінал та виконати команду запуску.

**Команда запуску:**

.. code:: json

    java -jar doc-sign-client-1.0.jar appId appSecret  &>> doc-sign.log &

де:

- appId і appSecret - дані для доступу
- doc-sign.log - файл куди буде записуватися лог додатку

За замовчуванням сервер запускається на *8082* порту.

Налаштування сервісу здійснюється за допомогою **web інтерфейсу**. Налаштування сервісу доступне тільки одному попередньо налаштованому користувачу, користувачам які створені в web інтерфейсі доступні тільки Http запити по API, описані нижче.

5 Опис web інтерфейсу
===============================================

Після розгортання сервісу перейдіть за отриманною web адресою та виконайте вхід за допомогою логіна та пароля.

.. image:: files/Modul_pidpysannia_Doc_Sign_Service_01.png
   :align: center

Відкриється основна сторінка - **Статистика**, на якій ви можете отримати основну інформацію про послугу, журнал логів та моживість пошуку по логам.

У блоці *Основна інформація* доступні дані про Статус послуги та Дату оновлення статусу, скільки Додано ключів, Кількість прийнятих на підпис документів, Кількість успішно підписаних документів та Кількість помилок. У *Журналі  логів* подана інформація про дату та статус підписання, назву документа а також вказано користувача, що здійснив підписання.

.. image:: files/Modul_pidpysannia_Doc_Sign_Service_06.png
   :align: center

У розділі **Ключі** доступна інформація про особисті ключі, а також форма для додавння ключів. Щоб додати ключ натисніть на кнопку **Додати ключ** - відкриється вікно для вибору файлу з вашого ПК або носія. Після вибору файлу, необхідно вказати *назву ключа* (обов'язково) - латинницею, та вказати *пароль* для ключа (обов'язково) та знову натиснути на *Додати ключ*.

.. image:: files/Modul_pidpysannia_Doc_Sign_Service_07.png
   :align: center

У розділі **Користувачі** можливо додати нового користувача, у якого буде доступ для використання запитів. Для цього натисніть на кнопку **Додати користувача** та вкажіть *логін* (обов'язково) - латинницею та без пробілів, та вкажіть *пароль* для користувача (обов'язково) та натисніть на *Додати користувача*.

.. image:: files/Modul_pidpysannia_Doc_Sign_Service_08.png
   :align: center

Нижче знаходиться список користувачів з можливістю редагування або блокування. Наприклад, Ви можете змінити пароль або редагувати логін для користувача.

.. image:: files/Modul_pidpysannia_Doc_Sign_Service_09.png
   :align: center

6 REST API
===============================================

REST API сервіс модуля підписання дозволяє:

* Підписувати вказані файли (.pdf) зазначеним набором ЕЦП
* Завантажувати архів з підписаним документом (оригінальний файл, файли підписів, файл з візуалізацією підпису)
* Завантажувати файл з візуалізацією підпису

6.1 Авторизація
------------------------------------

Для авторизаціїі використовується логін та пароль створеного користувача.

.. csv-table:: 
  :file: files/Authorization.csv
  :widths:  10, 41
  :stub-columns: 0

``RESPONSE``

В **заголовку відповіді** (Response header cookies) в json-форматі передається "ключ сесії" **SID**, необхідний для подальшої роботи. В кожному наступному запиті (виклику методу) повинен бути присутнім HTTP-заголовок (Header) "Authorization", який повинен містити токен "SID" зі значенням, отриманим при авторизації для коректного виконання запитів.

Тривалість сесії при бездіяльності користувача становить 10 хвилин (мається на увазі, що ключ сесії буде видалено через 10 хвилин, якщо користувач не буде активним (не буде відправляти HTTP запити)).

У **відповідь** передається код стану HTTP 200 (ok)

*Можливі помилки*:

 - 401, "Unauthorized" - перевірте введені дані, або перевірте правильність отриманного логіну та паролю.

--------------

6.2 Відправка документа на підписання
------------------------------------------------------------------------

.. csv-table:: 
  :file: files/sign-task.csv
  :widths:  10, 41
  :stub-columns: 0

``RESPONSE``

У **тілі відповіді** при успішному виконанні запиту, прийде *uuid завдання*, за яким надалі можна отримати результат підписання; у разі помилки - опис помилки.

*Можливі помилки*:

 - 400, "Bad Request" - при некоректному тілі запиту, або некоректним списком ключів, опис помилки буде зазначено в тілі відповіді.

--------------

6.3 Отримання листа підписання
------------------------------------------------------------------------

.. csv-table:: 
  :file: files/sign-list.csv
  :widths:  10, 41
  :stub-columns: 0

``RESPONSE``

У **тілі відповіді** при успішному виконанні запиту, повернеться PDF файл листа підписання (attachment).

*Можливі помилки*:

 - 404, "Not Found" - вказано некоректний task_uuid;
 - 102, "Processing" - файл ще обробляється, необхідно повторити запит пізніше;
 - 422, "опис помилки" - під час підписання виникла помилка;

--------------

6.4 Отримання архіву з результатом підписання
------------------------------------------------------------------------

.. csv-table:: 
  :file: files/sign-arch.csv
  :widths:  10, 41
  :stub-columns: 0

``RESPONSE``

У **тілі відповіді** при успішному виконанні запиту, повернеться ZIP-архів з результатом підписання (вихідний файл, файли
підписів, лист підписання).

*Можливі помилки*:

 - 404, "Not Found" - вказано некоректний task_uuid;
 - 102, "Processing" - файл ще обробляється, необхідно повторити запит пізніше;
 - 422, "опис помилки" - під час підписання виникла помилка;

