######################################################################
OCR API інтеграція
######################################################################


.. contents:: Зміст
    :depth: 2
    :local:

Дана інструкція описує послідовність викликів методів API, призначених для розпізнавання тексту та інтелектуального вилучення даних з документів.

Підтримувані типи документів, які можуть бути завантажені для обробки через API:
    * Рахунок-фактура
    * Накладна (товарна накладна, видаткова накладна)
    * Акт виконаних робіт


Послідовність дій
========================================================

1. Авторизація
--------------------------------------------------------

Для виклику методів API користувач повинен пройти `авторизацію <https://wiki.edin.ua/uk/latest/integration_2_0/APIv2/Methods/Authorization.html>`__ .

2. Відправка документа на розпізнання
--------------------------------------------------------

**URL**

.. table::

   +------------------+-----------------------------------------------------+
   | **Метод запиту** | POST                                                |
   +------------------+-----------------------------------------------------+
   | **URL запиту**   | https://edo-v2.edin.ua/api/ocr/experimental/v1/send | 
   +------------------+-----------------------------------------------------+

**Headers**

.. table::

   +-------------------+-----------------------------------------------------+
   | **Authorization** | {Session Key}                                       |
   +-------------------+-----------------------------------------------------+
   | **Content-Type**  | application/pdf | image/png | image/jpeg            |
   +-------------------+-----------------------------------------------------+


**REQUEST**

.. table::

   +----------------+--------------------------------------------------------+
   | **JSON Body**  | Байтовий вміст файлу (PDF/зображення)                  |
   +----------------+--------------------------------------------------------+

**RESPONSE**

У відповідь надходить унікальний ідентифікатор (**UUID**) завдання на конвертацію.


3. Отримання статусу обробки
-----------------------------------------------------------------

Метод рекомендовано викликати не частіше ніж 1 раз на 15 секунд.

**URL**

.. table::

   +------------------+---------------------------------------------------------------------------------+
   | **Метод запиту** | GET                                                                             |
   +------------------+---------------------------------------------------------------------------------+
   | **URL запиту**   | https://edo-v2.edin.ua/api/ocr/experimental/v1/result?task_uuid={UUID завдання} | 
   +------------------+---------------------------------------------------------------------------------+



**Headers**

.. table::

   +-------------------+------------------------------------------------------------+
   | **Authorization** | {Session Key}                                              |
   +-------------------+------------------------------------------------------------+

**RESPONSE**

У відповідь надходить статус завдання на конвертацію.

|Можливі статуси обробки завдання: 
|* **"CREATED"** - створено та очікує в черзі;
|* **"PROCESSING"** - в процесі виконання;
|* **"DONE"** — виконано;
|* **"ERROR"** — помилка.


4. Отримання результату конвертації
--------------------------------------------------------------

Метод викликається після отримання статусу **"DONE"**.

**URL**

.. table::

   +------------------+---------------------------------------------------------------------------------+
   | **Метод запиту** | GET                                                                             |
   +------------------+---------------------------------------------------------------------------------+
   | **URL запиту**   | https://edo-v2.edin.ua/api/ocr/experimental/v1/result?task_uuid={UUID завдання} | 
   +------------------+---------------------------------------------------------------------------------+

**Headers**

.. table::

   +-------------------+------------------------------------------------------------+
   | **Authorization** | {Session Key}                                              |
   +-------------------+------------------------------------------------------------+


**RESPONSE**

У відповідь надходить: 

    * результат конвертації у вигляді JSON-документа;
    * у заголовках (headers) відповіді присутній параметр X-Doc-Type, який містить визначений тип документа.
  

Приклад структури документів
========================================================

**JSON:**

.. code:: json

    {
        "documentname": "Назва документу",
        "Document-Header": {
            "InvoiceNumber": "номер документу. поле опціональне",
            "InvoiceDate": "дата документу. формат YYYY-MM-DD. поле опціональне",
            "DocumentFunctionCode": "Код типу документа: TN - товарна накладна/накладна, PRN- Цінова накладна, DRN - Видаткова накладна",
            "ContractNumber": "Номер договору",
            "ContractDate": "дата договору. формат YYYY-MM-DD. поле опціональне",
            "Route": "маршрут",
            "DeliveryTerms": "умови поставки",
            "DeliveryTime": "час доставки",
            "CarNumber":"номер автомобіля",
            "PayToDate":"сплатити до дати. формат YYYY-MM-DD. поле опціональне"
        },
        "AdditionalInfo": [
            {
            "name": "назва",
            "value": "значення"
            }
        ],
        "Document-Reference": {
            "Order": {
            "BuyerOrderNumber": "Номер замовлення",
            "BuyerOrderDate": "дата замовлення. формат YYYY-MM-DD. поле опціональне"
            },
            "TaxInvoice": {
            "TaxInvoiceNumber": "Номер податкової накладної.",
            "TaxInvoiceDate": "дата податкової накладної. формат YYYY-MM-DD. поле опціональне"
            },
            "DespatchAdvice": {
            "DespatchAdviceNumber": "Номер повідомлення про відвантаження."
            },
            "ReceivingAdvice": {
            "ReceivingAdviceNumber": "Номер повідомлення про прийом",
            "DeliveryDate": "Дата приймання. формат YYYY-MM-DD. поле опціональне"
            }
        },
        "Document-Parties": {
            "Buyer": {
            "ILN": "GLN покупця",
            "TaxID": "ІПН покупця",
            "UtilizationRegisterNumber": "ЄДРПОУ покупця",
            "Name": "назва компанії покупця",
            "StreetAndNumber": "вулиця/проспект/бульвар і номер будинку покупця",
            "CityName": "місто покупця",
            "PostalCode": "поштовий код покупця",
            "PhoneNumber": "телефоний номер покупця",
            "IBAN": "IBAN покупця",
            "Email": "email"
            },
            "Seller": {
            "ILN": "GLN продавця",
            "TaxID": "ІПН продавця",
            "CodeByBuyer": "Номер договору на поставку",
            "UtilizationRegisterNumber": "ЄДРПОУ продавця",
            "Name": "Назва компанії продавця",
            "StreetAndNumber": "вулиця/проспект/бульвар і номер будинку продавця",
            "CityName": "місто продавця",
            "PostalCode": "поштовий код продавця",
            "PhoneNumber": "телефоний номер продавця",
            "IBAN": "IBAN продавця",
            "Email": "email"
            },
            "DeliveryPoint": {
            "ILN": "GLN точки дотсавки",
            "DeliveryPlace": "77"
            },
            "Payer": {
            "ILN": "GLN платника"
            }
        },
        "Docement-Lines": [
            {
            "LineNumber": "номер позиції в табличній частині",
            "EAN": "Штрих-код продукту відповідно до стандарту EAN-8 та EAN-13",
            "BuyerItemCode": "Артикул/код товару",
            "CertNumber":"номер сертифікату",
            "ExternalItemCode": "Код товару згідно з довідника УКТ ЗЕД. завжди складається з 10 символів",
            "ItemDescription": "назва товару/послуги",
            "InvoiceQuantity": "Замовлена кількість",
            "UnitOfMeasure": "одиниці виміру",
            "InvoiceUnitNetPrice": "Ціна однієї одиниці без ПДВ",
            "TaxRate": "Ставка ПДВ (20/19/16/14/7/2/0)",
            "TaxCategoryCode": "Код категорії податку:S - стандартний податок; можливі значення TaxRate: 20/19/16/14/7/2 (інакше помилка),E - звільнений від сплати податку; можливі значення TaxRate=0, Z - нульова ставка (0%); можливі значення TaxRate=0",
            "TaxAmount": "Сума ПДВ по позиції",
            "NetAmount": "Всього без ПДВ"
            }
        ],
        "Document-Summary": {
            "TotalLines": "Кількість рядків в документі",
            "TotalNetAmount": "Загальна сума без ПДВ",
            "TotalTaxAmount": "Сума ПДВ",
            "TotalGrossAmount": "Загальна сума з ПДВ",
            "Tax-Summary": [
            {
                "TaxRate": "Ставка ПДВ (20/7/0)",
                "TaxCategoryCode": "Код категорії податку:S - стандартний податок; можливі значення TaxRate: 20/19/16/14/7/2 (інакше помилка),E - звільнений від сплати податку; можливі значення TaxRate=0, Z - нульова ставка (0%); можливі значення TaxRate=0",
                "TaxAmount": "Сума податку для конкретної категорії податку",
                "TaxableAmount": "Оподаткована сума для конкретної категорії податку"
            }
            ]
        }
    }


Коди помилок 
========================================================

 `400` - сервер поверне одну із помилок, описаних нижче;
 `500` - внутрішня помилка сервера. Зверніться до технічної підтримки. 

Помилки методу `POST /api/ocr/experimental/v1/send`:
    * **User not configured** - у користувача не налаштовані правила конвертації документів. Зверніться до закріпленого менеджера.
    * **Unsupported content type: {тип, який користувач передав у запиті}** - непідтримуваний тип файлу. Тип файлів, які підтримуються: "application/pdf", "image/png", "image/jpeg".
    * **Request body is empty** - тіло запиту порожнє.

Помилки методу `GET /api/ocr/experimental/v1/status`:
    * **Task not found for uuid: {UUID}** - завдання з вказаним UUID не знайдено.

Помилки методу `GET /api/ocr/experimental/v1/result`:
    * **Task is still processing** — завдання ще в процесі конвертації. Результат недоступний.
    * **Convert document to JSON error** — помилка під час конвертації документа.
    * **Task not found for uuid: {UUID}** — завдання з указаним UUID не знайдено.