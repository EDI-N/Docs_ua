###########################################################################################################################################
Правила заповнення "e-TTH" для мережі "МЕТРО"
###########################################################################################################################################

Товарно-транспортна накладна (ТТН) є одним із ключових документів у документообігу між контрагентами. Для того щоб ТТН, передача якої здійснюється через FTP/AS2, була коректно пов’язана з документом-підставою, необхідно дотримуватись відповідних правил її заповнення.

**1. Загальні правила**
====================================

**1. Наявність документа-підстави**

У процесі обміну документами з мережею **«Метро»** використовується документ **«Транспортна накладна»**. При формуванні ТТН інформація про документ-підставу **«Транспортна накладна»** обов’язково має бути заповнена у блоці **«Супровідні документи»**.

У XML-структурі цей блок визначається як “AssociatedReferencedDocument”. 

Поля та правила заповнення:
    *   **"TypeCode"** - код (числове значення) типу документа-підстави (обов’язково):
        * ``780`` - Транспортна накладна (DOCUMENTINVOICE_TNN);
    *   **"ID"** – номер документа-підстави (обов’язково);
    *   **"Remarks"** – UUID документа-підстави на платформі EDIN (опційно);
    *   **"DateTimeString"** – Дата та час документа-підстави (обов’язково).

Номер і дата документа-підстави у блоці “AssociatedReferencedDocument” заповнюються відповідно до даних цього документа.
Вони вказуються в тілі цього документа в однойменних тегах (номер і дата) згідно зі специфікацією.

**XML-example**

.. code:: xml

    <ram:AssociatedReferencedDocument>
        <ram:TypeCode>780</ram:TypeCode>
        <ram:ID>GK_40409997_AN12</ram:ID>
        <ram:Remarks>4b39d-656-4d88-bc5d-c5c6879613c9</ram:Remarks>
        <ram:FormattedIssueDateTime>
            <qdt:DateTimeString>2025-01-15T12:00:00+02:00</qdt:DateTimeString>
        </ram:FormattedIssueDateTime>
    </ram:AssociatedReferencedDocument>

**2. Заповнення GLN компаній-учасників ТТН**

При формуванні ТТН для кожного з учасників документообігу у “______TradeParty” необхідно заповнювати GLN.

Інформація про GLN вноситься до блоку “SpecifiedGovernmentRegistration”.

Поля та правила заповнення:
    *   **"ID"** - GLN компанії-учасника;
    *   **"TypeCode"** - значення за замовчуванням: TRADEPARTY_GLN.

.. important::
    GLN у ТТН та документі-підставі мають збігатися.

        * GLN відправника (Sender) заповнюється у блоці “ConsignorTradeParty”
        * GLN отримувача (Recipient) заповнюється у блоках “ConsigneeTradeParty” та “ConsigneeReceiptLogisticsLocation”

**XML-example**

.. code:: xml

    <ram:ConsignorTradeParty>
        <ram:ID schemeAgencyID="ЄДРПОУ">3211129</ram:ID>
        <ram:Name>ТОВ "ТЕСТ"</ram:Name>
        <ram:RoleCode>CZ</ram:RoleCode>
        <ram:PostalTradeAddress>
            <ram:PostcodeCode>01168</ram:PostcodeCode>
            <ram:StreetName>вул. Барабашова</ram:StreetName>
            <ram:CityName>Харків</ram:CityName>
            <ram:CountryID>UA</ram:CountryID>
            <ram:CountrySubDivisionName>Харківська</ram:CountrySubDivisionName>
        </ram:PostalTradeAddress>
        <ram:SpecifiedGovernmentRegistration>
            <ram:ID>4820062440004</ram:ID>
            <ram:TypeCode>TRADEPARTY_GLN</ram:TypeCode>
        </ram:SpecifiedGovernmentRegistration>
    </ram:ConsignorTradeParty>

**3. Додаткові умови та перевірки ТТН при роботі з мережею «Метро»**

*   Заборонено зазначати в ТТН інформацію про вартість товарів.

    Поля, які мають лишитись порожніми: **"Ціна з ПДВ"**, **"Ціна без ПДВ"**, **"Сума з ПДВ"** та **"Сума без ПДВ"** зазначаються в тегах:
        *   ``IncludedSupplyChainConsignmentItem.ApplicableNote.Content`` (з кодом PRICE_WITH_VAT);
        *   ``IncludedSupplyChainConsignmentItem.TariffQuantity``;
        *   ``IncludedSupplyChainConsignmentItem.InvoiceAmount``;
        *   ``IncludedSupplyChainConsignmentItem.ApplicableNote.Content`` (з кодом SUM_WITHOUT_VAT).

*   Заборонено Вантажовідправнику надсилати ТТН з однаковим номером більше ніж один раз у межах календарного року.

**Дефолтна логіка обробки документів**

Для коректного визначення зв’язків між документами, а також правильної обробки ТТН зі сторони мережі «Метро», необхідно дотримуватись правил заповнення тіла ТТН, описаних у пунктах вище (п.1 та п.2).

Якщо хоча б один із пунктів не виконано, до ТТН застосовується дефолтна логіка обробки:

    *   Якщо не вказано документ-підставу, ТТН буде оброблена в системі EDIN, але через неможливість визначити пакет документів для неї буде створено новий пакет.
    *   Якщо не вказано GLN вантажовідправника та/або вантажоотримувача, пошук документа-підстави здійснюватиметься в межах основного GLN компанії.
        Якщо пакет документів не знайдено, для ТТН буде створено новий пакет.

.. note::
    **Основний GLN** – має унікальний ЄДРПОУ на рівні платформи EDIN та використовується для документів, що потребують підпису КЕП. Він створюється автоматично при реєстрації на платформі EDI Network.

**2. Зміни згідно з наказом №1332**
====================================

**2.1. Блок: «Відомості про транспортний засіб»** 

У ТТН необхідно заповнити інформацію про транспортний засіб, який бере участь у перевезенні. Ця інформація вноситься в поле **«Відомості про транспортний засіб (автомобіль / автопоїзд / комбінований транспортний засіб)»** (у структурі ТТН — блок ``ram:IncludedNote``).

Поля та правила заповнення:

    *   **Довжина** - загальна довжина автопоїзда. Вимірюється від переднього бампера автомобіля до заднього бампера останнього авто / причепа / напівпричепа. Вказується в метрах.
        *   ``ram:ContentCode.listAgencyID`` - ``vehicle_length`` (дефолт);
        *   ``ram:ContentCode.value`` – значення (число);
        *   ``ram:Content`` – код ролі учасника = ``CZ`` (дефолт).

    *   **Ширина(максимальна)** – максимальна ширина автопоїзда в метрах.
        *   ``ram:ContentCode.listAgencyID`` – ``vehicle_width`` (дефолт);
        *   ``ram:ContentCode.value`` – значення (число);
        *   ``ram:Content``  – код ролі учасника = ``CZ`` (дефолт).

    